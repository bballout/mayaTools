import pymel.core as pm
import igLibrary as ig

#detach rig
rjc = igRigboxJr.igRigboxJrUIClass()
rjc.detachRig()
pm.refresh()

#create joints
cmds.select('LF_upleg')
lfHelperJnt = cmds.joint(name='LF_upleg_helper_1',radius=1.5)
cmds.select('pelvis')
lfHelperJntSolver = cmds.joint(name='LF_upleg_helper_solver_1',radius=2.0)
cmds.select('RT_upleg')
rtHelperJnt = cmds.joint(name='RT_upleg_helper_1',radius=1.5)
cmds.select('pelvis')
rtHelperJntSolver = cmds.joint(name='RT_upleg_helper_solver_1',radius=2.0)

#align helper joints
lfPos = cmds.xform('LF_upleg',q=True,ws=True,translation=True)
rtPos = cmds.xform('RT_upleg',q=True,ws=True,translation=True)
cmds.move(lfPos[0],lfPos[1],lfPos[2],lfHelperJntSolver)
cmds.move(rtPos[0],rtPos[1],rtPos[2],rtHelperJntSolver)

#set orients
lfLegOrient = cmds.getAttr('LF_upleg.jointOrient')[0]
rtLegOrient = cmds.getAttr('LF_upleg.jointOrient')[0]
cmds.setAttr('LF_upleg_helper_solver_1.jointOrientX',lfLegOrient[0])
cmds.setAttr('LF_upleg_helper_solver_1.jointOrientY',lfLegOrient[1])
cmds.setAttr('LF_upleg_helper_solver_1.jointOrientZ',lfLegOrient[2])
cmds.setAttr('RT_upleg_helper_solver_1.jointOrientX',rtLegOrient[0])
cmds.setAttr('RT_upleg_helper_solver_1.jointOrientY',rtLegOrient[1])
cmds.setAttr('RT_upleg_helper_solver_1.jointOrientZ',rtLegOrient[2])

#set rotation order
cmds.setAttr('LF_upleg_helper_1.rotateOrder',2)
cmds.setAttr('RT_upleg_helper_1.rotateOrder',2)
cmds.setAttr('LF_upleg_helper_solver_1.rotateOrder',2)
cmds.setAttr('RT_upleg_helper_solver_1.rotateOrder',2)

#build solver locators
locGrp = cmds.group(empty=True,name='helper_loc_grp')
lfLocGrp = cmds.group(empty=True,name='LF_upleg_helper_1_loc_grp')
lfLoc = cmds.spaceLocator(name='LF_upleg_helper_1_loc')
cmds.parent(lfLoc,lfLocGrp)

rtLocGrp = cmds.group(empty=True,name='RT_upleg_helper_1_loc_grp')
rtLoc = cmds.spaceLocator(name='RT_upleg_helper_1_loc')
cmds.parent(rtLoc,rtLocGrp)

cmds.parent(lfLocGrp,locGrp)
cmds.parent(rtLocGrp,locGrp)

#set rotate order for solver locators
cmds.setAttr('LF_upleg_helper_1_loc.rotateOrder',2)
cmds.setAttr('RT_upleg_helper_1_loc.rotateOrder',2)

#set joint rotate limits
cmds.transformLimits('LF_upleg_helper_solver_1',rz=(-360,0),erz=(0,1))
cmds.transformLimits('RT_upleg_helper_solver_1',rz=(-360,0),erz=(0,1))

#set up constraints for solver locators
tempCon = cmds.parentConstraint('LF_upleg','LF_upleg_helper_1_loc_grp',mo=False)
cmds.delete(tempCon)
tempCon = cmds.parentConstraint('RT_upleg','RT_upleg_helper_1_loc_grp',mo=False)
cmds.delete(tempCon)

cmds.parentConstraint('pelvis','LF_upleg_helper_1_loc_grp',mo=True)
cmds.parentConstraint('pelvis','RT_upleg_helper_1_loc_grp',mo=True)
cmds.parentConstraint('LF_upleg','LF_upleg_helper_1_loc',mo=False)
cmds.parentConstraint('RT_upleg','RT_upleg_helper_1_loc',mo=False)

#connect rotate to helper joint solver
cmds.connectAttr('LF_upleg_helper_1_loc.rotateZ','LF_upleg_helper_solver_1.rotateZ')
cmds.connectAttr('RT_upleg_helper_1_loc.rotateZ','RT_upleg_helper_solver_1.rotateZ')

#constrain helper joint solver to helper joint bind
cmds.parentConstraint('LF_upleg_helper_solver_1','LF_upleg_helper_1')
cmds.parentConstraint('RT_upleg_helper_solver_1','RT_upleg_helper_1')

#add iglocs to avoid joint pruning
cmds.spaceLocator(name='igLoc_LF_upleg_helper_solver_1')
cmds.parent('igLoc_LF_upleg_helper_solver_1','LF_upleg_helper_1',r=True)
cmds.spaceLocator(name='igLoc_RT_upleg_helper_solver_1')
cmds.parent('igLoc_RT_upleg_helper_solver_1','RT_upleg_helper_1',r=True)

#place locators in main exclude grp
excludeGrpName = ''
excludeGrps = cmds.ls('Exclude')
for excludeGrp in excludeGrps:
    splitName = excludeGrp.split('|')[0]
    if not splitName in ['Geometry','geometry','LookGroup','Looks']:
        excludeGrpName = excludeGrp
try:
    cmds.parent(locGrp,excludeGrpName)
except:
    pass

#attach rig
rjc.attachRig()